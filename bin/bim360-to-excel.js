#!/usr/bin/env node

// Command-line tool for exporting BIM360 issues into XLSX file based on a configuration file generated by the web application.
//
// Note: since the configuration file includes potentially exploitable information (2-legged and 3-legged tokens),
// it is provided in a ZIP archive protected by a password configured in the env. variable CLI_CONFIG_PASSWORD.
//
// Usage:
//    1. Run the server application in this project
//    2. Visit this application's web interface and navigate to the issue page for one of your BIM360 projects
//    3. Use the "Command-Line Config" button at the bottom of the page to download the compressed configuration file
//    4. Extract the configuration JSON from the archive
//    5. Run the following command from the command line:
//        node bim360-to-excel.js <path/to/unzipped/config.json> <path/to/output.xlsx>

const fse = require('fs-extra');
const { exportIssues } = require('../helpers/excel');

async function run(configPath, outputPath) {
    try {
        const config = fse.readJsonSync(configPath);
        console.log(`Exporting issues from BIM360 project ${config.project_id} into ${outputPath}.`);
        const xlsx = await exportIssues(config);
        fse.ensureFileSync(outputPath);
        fse.writeFileSync(outputPath, xlsx);
        console.log('Done.');
    } catch (err) {
        console.error(err);
        process.exit(1);
    }
}

run(process.argv[2], process.argv[3]);
